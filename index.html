<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swayam Library (Email/Password Auth)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            line-height: 1.6;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4 text-center">Swayam Library</h1>
        <div class="flex justify-between items-center mb-6">
            <p id="currentUserId" class="text-sm text-gray-600 break-words">User ID: Not Logged In</p>
            <p id="currentUserName" class="text-sm text-gray-700 font-medium ml-4">Hello, Guest!</p>
            <button id="logoutBtn" class="hidden px-4 py-2 bg-gray-200 text-gray-800 text-sm font-semibold rounded-md hover:bg-gray-300 transition duration-150 ease-in-out">
                Logout
            </button>
        </div>

        <!-- Authentication Section -->
        <div id="authContainer" class="p-6 bg-gray-50 rounded-lg border border-gray-200 shadow-sm mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Login or Register</h2>
            <div id="authError" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4 rounded-md" role="alert"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div id="registrationFields" class="md:col-span-2 hidden">
                    <div>
                        <label for="firstNameInput" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="firstNameInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="John">
                    </div>
                    <div class="mt-2">
                        <label for="lastNameInput" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="lastNameInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Doe">
                    </div>
                </div>
                <div>
                    <label for="emailInput" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="emailInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="you@example.com">
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="passwordInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="••••••••">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="registerBtn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Register
                </button>
                <button id="loginBtn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Login
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-4 text-center">
                <span id="toggleToLogin" class="text-blue-600 hover:underline cursor-pointer hidden">Already have an account? Login here.</span>
                <span id="toggleToRegister" class="text-blue-600 hover:underline cursor-pointer">Don't have an account? Register here.</span>
            </p>
        </div>

        <!-- Main Library Content -->
        <div id="libraryContent" class="hidden">
            <!-- Notification for requests -->
            <div id="requestNotification" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md shadow-sm" role="alert">
                <p class="font-bold">New Book Request!</p>
                <p>You have <span id="pendingRequestsCount">0</span> pending book requests.</p>
                <button id="viewRequestsBtn" class="mt-2 text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out">
                    View Requests
                </button>
            </div>

            <!-- Add Book Section -->
            <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200 shadow-sm">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4">Add a New Book</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="bookTitleInput" class="block text-sm font-medium text-gray-700 mb-1">Book Title</label>
                        <input type="text" id="bookTitleInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="The Great Gatsby">
                    </div>
                    <div>
                        <label for="bookAuthorInput" class="block text-sm font-medium text-gray-700 mb-1">Author</label>
                        <input type="text" id="bookAuthorInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="F. Scott Fitzgerald">
                    </div>
                     <div>
                        <label for="ownerNameInput" class="block text-sm font-medium text-gray-700 mb-1">Your Name (as Book Owner)</label>
                        <input type="text" id="ownerNameInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Your Name">
                    </div>
                </div>
                <button id="addBookBtn" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Add Book to Library
                </button>
            </div>

            <!-- My Books Section -->
            <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200 shadow-sm">
                <h2 class="text-2xl font-semibold text-purple-800 mb-4">My Books</h2>
                <div id="myBooksList" class="space-y-4">
                    <p id="noMyBooksMessage" class="text-gray-500 text-center">You haven't added any books yet.</p>
                </div>
            </div>

            <!-- All Available Books Section -->
            <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200 shadow-sm">
                <h2 class="text-2xl font-semibold text-green-800 mb-4">All Available Books (for Request)</h2>
                <div id="availableBooksList" class="space-y-4">
                    <p id="noAvailableBooksMessage" class="text-gray-500 text-center">No books currently available for request from other users.</p>
                </div>
            </div>

            <!-- My Issued Books Section -->
            <div class="mb-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200 shadow-sm">
                <h2 class="text-2xl font-semibold text-indigo-800 mb-4">Books Issued To Me</h2>
                <div id="myIssuedBooksList" class="space-y-4">
                    <p id="noIssuedBooksMessage" class="text-gray-500 text-center">You currently have no books issued to you.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-medium text-gray-800"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">Confirm</button>
                <button id="modalCancelBtn" class="px-5 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Request Management Modal -->
    <div id="requestsModal" class="modal">
        <div class="modal-content w-full sm:w-1/2 max-w-2xl">
            <span class="close-button" id="closeRequestsModalBtn">&times;</span>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Pending Book Requests</h3>
            <div id="pendingRequestsList" class="space-y-4 max-h-96 overflow-y-auto">
                <p id="noPendingRequestsMessage" class="text-gray-500 text-center">No pending requests at the moment.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration ---
        // !!! IMPORTANT: YOU MUST REPLACE THESE WITH YOUR ACTUAL SUPABASE PROJECT URL AND ANON KEY !!!
        // You can find these in your Supabase Dashboard under Project Settings -> API.
        const SUPABASE_URL = 'https://tmtjqlhinhjpumzgsspa.supabase.co'; // e.g., 'https://abcde12345.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtdGpxbGhpbmhqcHVtemdzc3BhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyOTg0NDUsImV4cCI6MjA2NTg3NDQ0NX0.h75Cd0FbniB7gTE_xj7aHoiJjlkOVIwmgGfaMH4DNRc'; // e.g., 'eyJhbGciOiJIUzI1Ni...'

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let userId = null;
        let userProfileName = ''; // Stores the authenticated user's display name

        // UI Elements
        const authContainer = document.getElementById('authContainer');
        const libraryContent = document.getElementById('libraryContent');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const currentUserNameDisplay = document.getElementById('currentUserName');
        const logoutBtn = document.getElementById('logoutBtn');
        const authErrorDiv = document.getElementById('authError');

        const firstNameInput = document.getElementById('firstNameInput');
        const lastNameInput = document.getElementById('lastNameInput');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const registerBtn = document.getElementById('registerBtn'); // Renamed from showRegisterBtn
        const loginBtn = document.getElementById('loginBtn');
        const registrationFields = document.getElementById('registrationFields');
        const toggleToLogin = document.getElementById('toggleToLogin');
        const toggleToRegister = document.getElementById('toggleToRegister');

        const bookTitleInput = document.getElementById('bookTitleInput');
        const bookAuthorInput = document.getElementById('bookAuthorInput');
        const ownerNameInput = document.getElementById('ownerNameInput'); // This will default to userProfileName
        const addBookBtn = document.getElementById('addBookBtn');
        const myBooksList = document.getElementById('myBooksList');
        const noMyBooksMessage = document.getElementById('noMyBooksMessage');
        const availableBooksList = document.getElementById('availableBooksList');
        const noAvailableBooksMessage = document.getElementById('noAvailableBooksMessage');
        const myIssuedBooksList = document.getElementById('myIssuedBooksList');
        const noIssuedBooksMessage = document.getElementById('noIssuedBooksMessage');
        const requestNotification = document.getElementById('requestNotification');
        const pendingRequestsCount = document.getElementById('pendingRequestsCount');
        const viewRequestsBtn = document.getElementById('viewRequestsBtn');
        const requestsModal = document.getElementById('requestsModal');
        const closeRequestsModalBtn = document.getElementById('closeRequestsModalBtn');
        const pendingRequestsList = document.getElementById('pendingRequestsList');
        const noPendingRequestsMessage = document.getElementById('noPendingRequestsMessage');

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const closeModalButtons = document.querySelectorAll('.close-button'); // For all modals

        let currentModalAction = null; // Stores the function to execute on modal confirmation

        // --- Utility Functions ---
        function showAuthError(message) {
            authErrorDiv.textContent = message;
            authErrorDiv.classList.remove('hidden');
        }

        function hideAuthError() {
            authErrorDiv.classList.add('hidden');
            authErrorDiv.textContent = '';
        }

        function clearAuthInputs() {
            firstNameInput.value = '';
            lastNameInput.value = '';
            emailInput.value = '';
            passwordInput.value = '';
        }

        // --- UI State Management ---
        function updateUIForAuthenticatedUser(user) {
            userId = user.id;
            userProfileName = user.user_metadata?.full_name || user.email || 'User'; // Prioritize full_name if set
            currentUserIdDisplay.textContent = `User ID: ${userId}`;
            currentUserNameDisplay.textContent = `Hello, ${userProfileName}!`;
            ownerNameInput.value = userProfileName; // Pre-fill owner name with logged-in user's name

            authContainer.classList.add('hidden');
            libraryContent.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            addBookBtn.disabled = false; // Enable adding books

            hideAuthError();
            clearAuthInputs(); // Clear auth form inputs after successful login/reg

            setupSupabaseListeners(); // Start listening to data once authenticated
        }

        function updateUIForLoggedOutUser() {
            userId = null;
            userProfileName = '';
            currentUserIdDisplay.textContent = 'User ID: Not Logged In';
            currentUserNameDisplay.textContent = 'Hello, Guest!';
            ownerNameInput.value = '';

            authContainer.classList.remove('hidden');
            libraryContent.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            addBookBtn.disabled = true; // Disable adding books

            // Clear book lists
            myBooksList.innerHTML = '<p id="noMyBooksMessage" class="text-gray-500 text-center">Please log in to view your books.</p>';
            availableBooksList.innerHTML = '<p class="text-gray-500 text-center">Please log in to view available books.</p>';
            myIssuedBooksList.innerHTML = '<p class="text-gray-500 text-center">Please log in to view issued books.</p>';
            requestNotification.classList.add('hidden'); // Hide notification

            // Stop real-time listeners if subscribed
            supabase.removeAllSubscriptions(); // Ensure all subscriptions are removed on logout
        }

        // --- Supabase Authentication Methods ---
        async function initSupabaseAuth() {
            // Listen for auth state changes
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth event:', event, 'Session:', session);
                if (session) {
                    updateUIForAuthenticatedUser(session.user);
                } else {
                    updateUIForLoggedOutUser();
                }
            });

            // Immediately check for a session on load
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                updateUIForAuthenticatedUser(session.user);
            } else {
                updateUIForLoggedOutUser();
            }
        }

        // Register User
        registerBtn.addEventListener('click', async (e) => { // Renamed from showRegisterBtn
            e.preventDefault(); // Prevent default form submission if this was a form button
            hideAuthError();

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();

            if (!email || !password || !firstName || !lastName) {
                showAuthError("Please fill in all fields (First Name, Last Name, Email, Password) to register.");
                return;
            }
            if (password.length < 6) {
                showAuthError("Password must be at least 6 characters long.");
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            full_name: `${firstName} ${lastName}` // Store full name for convenience
                        }
                    }
                });

                if (error) throw error;

                if (data.user && data.user.identities && data.user.identities.length === 0) {
                     // This means email verification is required but not yet done.
                     showConfirmationModal("Registration successful! Please check your email to verify your account and then log in.", () => {});
                     clearAuthInputs();
                } else {
                    showConfirmationModal("Registration successful! You are now logged in.", () => {});
                    // onAuthStateChange listener will handle updating the UI
                }

            } catch (error) {
                console.error('Error during registration:', error);
                showAuthError(`Registration failed: ${error.message}`);
            }
        });

        // Login User
        loginBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            hideAuthError();

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showAuthError("Please enter your email and password to log in.");
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;
                showConfirmationModal("Login successful! Welcome back.", () => {});
                // onAuthStateChange listener will handle updating the UI
            } catch (error) {
                console.error('Error during login:', error);
                showAuthError(`Login failed: ${error.message}`);
            }
        });

        // Logout User
        logoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error logging out:', error.message);
                showConfirmationModal(`Error logging out: ${error.message}`, () => {});
            } else {
                showConfirmationModal("Logged out successfully.", () => {});
                // onAuthStateChange listener will handle updating the UI
            }
        });

        // Toggle between Login and Register views
        toggleToLogin.addEventListener('click', () => {
            registrationFields.classList.add('hidden');
            registerBtn.classList.add('hidden'); // Hide Register button
            loginBtn.classList.remove('hidden'); // Show Login button
            toggleToLogin.classList.add('hidden');
            toggleToRegister.classList.remove('hidden');
            hideAuthError();
            clearAuthInputs();
        });

        toggleToRegister.addEventListener('click', () => {
            registrationFields.classList.remove('hidden');
            registerBtn.classList.remove('hidden'); // Show Register button
            loginBtn.classList.add('hidden'); // Hide Login button
            toggleToLogin.classList.remove('hidden');
            toggleToRegister.classList.add('hidden');
            hideAuthError();
            clearAuthInputs();
        });


        // --- Confirmation Modal Functions (unchanged from previous) ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmationModal.style.display = 'flex';
            currentModalAction = onConfirm;
        }

        function hideConfirmationModal() {
            confirmationModal.style.display = 'none';
            currentModalAction = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (currentModalAction) {
                currentModalAction();
            }
            hideConfirmationModal();
        });

        modalCancelBtn.addEventListener('click', () => {
            hideConfirmationModal();
        });

        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                requestsModal.style.display = 'none';
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target == confirmationModal) {
                hideConfirmationModal();
            }
            if (event.target == requestsModal) {
                requestsModal.style.display = 'none';
            }
        });


        // --- Supabase Database Operations (adapted for Supabase column names) ---

        /**
         * Adds a new book to Supabase.
         */
        addBookBtn.addEventListener('click', async () => {
            if (!userId) {
                showConfirmationModal("You must be logged in to add a book.", () => {});
                return;
            }

            const title = bookTitleInput.value.trim();
            const author = bookAuthorInput.value.trim();
            const ownerName = ownerNameInput.value.trim(); // This input will be pre-filled with logged-in user's name

            if (!title || !author || !ownerName) {
                showConfirmationModal("Please fill in all book details (Title, Author, Your Name).", () => {});
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('books')
                    .insert([
                        {
                            owner_id: userId,
                            owner_name: ownerName,
                            book_title: title,
                            book_author: author,
                            status: 'available'
                        }
                    ]);

                if (error) throw error;

                bookTitleInput.value = '';
                bookAuthorInput.value = '';
                // ownerNameInput.value will be re-populated by updateUIForAuthenticatedUser or left as is
                showConfirmationModal("Book added successfully!", () => {});
            } catch (e) {
                console.error("Error adding book: ", e);
                showConfirmationModal(`Error adding book: ${e.message}`, () => {});
            }
        });

        /**
         * Sends a request for a book.
         * @param {Object} book - The book object to request.
         */
        async function requestBook(book) {
            if (!userId) {
                showConfirmationModal("You must be logged in to request a book.", () => {});
                return;
            }
            if (book.status !== 'available') {
                showConfirmationModal("This book is not available for request.", () => {});
                return;
            }
            if (book.owner_id === userId) {
                 showConfirmationModal("You cannot request your own book.", () => {});
                return;
            }

            showConfirmationModal(`Are you sure you want to request "${book.book_title}" from ${book.owner_name}?`, async () => {
                try {
                    // Update book status to 'requested'
                    const { error: bookUpdateError } = await supabase
                        .from('books')
                        .update({
                            status: 'requested',
                            requested_by_person_id: userId,
                            requested_by_person_name: userProfileName // Use the authenticated user's name
                        })
                        .eq('id', book.id);

                    if (bookUpdateError) throw bookUpdateError;

                    // Create a request document
                    const { data: requestData, error: requestError } = await supabase
                        .from('requests')
                        .insert([
                            {
                                book_id: book.id,
                                book_title: book.book_title,
                                owner_id: book.owner_id,
                                owner_name: book.owner_name,
                                requester_id: userId,
                                requester_name: userProfileName // Use the authenticated user's name
                            }
                        ]);

                    if (requestError) throw requestError;

                    showConfirmationModal(`Request for "${book.book_title}" sent successfully!`, () => {});
                } catch (e) {
                    console.error("Error requesting book: ", e);
                    showConfirmationModal(`Error requesting book: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Approves a book request.
         * @param {Object} request - The request object.
         */
        async function approveRequest(request) {
            if (!userId || request.owner_id !== userId) return; // Only owner can approve

            showConfirmationModal(`Approve request for "${request.book_title}" by ${request.requester_name}?`, async () => {
                try {
                    // Update book status to 'issued' and assign to requester
                    const { error: bookUpdateError } = await supabase
                        .from('books')
                        .update({
                            status: 'issued',
                            issued_to_person_id: request.requester_id,
                            issued_to_person_name: request.requester_name,
                            requested_by_person_id: null, // Clear request fields
                            requested_by_person_name: null
                        })
                        .eq('id', request.book_id);

                    if (bookUpdateError) throw bookUpdateError;

                    // Delete the request
                    const { error: requestDeleteError } = await supabase
                        .from('requests')
                        .delete()
                        .eq('id', request.id);

                    if (requestDeleteError) throw requestDeleteError;

                    showConfirmationModal(`Request for "${request.book_title}" approved!`, () => {});
                } catch (e) {
                    console.error("Error approving request: ", e);
                    showConfirmationModal(`Error approving request: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Rejects a book request.
         * @param {Object} request - The request object.
         */
        async function rejectRequest(request) {
            if (!userId || request.owner_id !== userId) return; // Only owner can reject

            showConfirmationModal(`Reject request for "${request.book_title}" by ${request.requester_name}?`, async () => {
                try {
                    // Update book status back to 'available'
                    const { error: bookUpdateError } = await supabase
                        .from('books')
                        .update({
                            status: 'available',
                            requested_by_person_id: null, // Clear request fields
                            requested_by_person_name: null
                        })
                        .eq('id', request.book_id);

                    if (bookUpdateError) throw bookUpdateError;

                    // Delete the request
                    const { error: requestDeleteError } = await supabase
                        .from('requests')
                        .delete()
                        .eq('id', request.id);

                    if (requestDeleteError) throw requestDeleteError;

                    showConfirmationModal(`Request for "${request.book_title}" rejected.`, () => {});
                } catch (e) {
                    console.error("Error rejecting request: ", e);
                    showConfirmationModal(`Error rejecting request: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Marks an issued book as returned.
         * @param {Object} book - The book object to return.
         */
        async function returnBook(book) {
            // Only the owner or the person it's issued to can mark as returned
            if (!userId || (book.owner_id !== userId && book.issued_to_person_id !== userId)) {
                showConfirmationModal("You are not authorized to return this book.", () => {});
                return;
            }

            showConfirmationModal(`Confirm returning "${book.book_title}"?`, async () => {
                try {
                    const { error } = await supabase
                        .from('books')
                        .update({
                            status: 'available',
                            issued_to_person_id: null,
                            issued_to_person_name: null
                        })
                        .eq('id', book.id);

                    if (error) throw error;
                    showConfirmationModal(`"${book.book_title}" marked as returned and available.`, () => {});
                } catch (e) {
                    console.error("Error returning book: ", e);
                    showConfirmationModal(`Error returning book: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Deletes a book from Supabase.
         * @param {string} bookId - The ID of the book to delete.
         */
        async function deleteBook(bookId) {
            showConfirmationModal("Are you sure you want to delete this book? This action cannot be undone.", async () => {
                try {
                    const { error } = await supabase
                        .from('books')
                        .delete()
                        .eq('id', bookId);

                    if (error) throw error;
                    showConfirmationModal("Book deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting book: ", e);
                    showConfirmationModal(`Error deleting book: ${e.message}`, () => {});
                }
            });
        }


        // --- Real-time Listeners and UI Rendering ---
        function setupSupabaseListeners() {
            // Only subscribe if userId is available and not null (i.e., user is logged in)
            if (!userId) {
                console.warn("Not subscribing to real-time updates as user is not logged in.");
                return;
            }

            // Unsubscribe from previous listeners to avoid duplicates if auth state changes
            supabase.removeAllSubscriptions();


            // Listener for all books (real-time changes)
            supabase
                .from('books')
                .on('*', payload => { // Listen to all changes (INSERT, UPDATE, DELETE)
                    console.log('Book change received!', payload);
                    fetchAndRenderBooks(); // Re-fetch and re-render all lists
                })
                .subscribe();

            // Listener for incoming requests (only for the current user as owner)
            supabase
                .from('requests')
                .on('*', payload => { // Listen to all changes (INSERT, UPDATE, DELETE)
                    console.log('Request change received!', payload);
                    fetchAndRenderRequests(); // Re-fetch and re-render requests
                })
                .subscribe();

            // Initial fetch and render
            fetchAndRenderBooks();
            fetchAndRenderRequests();
        }

        /**
         * Fetches and renders all book lists from Supabase.
         */
        async function fetchAndRenderBooks() {
            if (!userId) {
                myBooksList.innerHTML = '<p class="text-gray-500 text-center">Please log in to view your books.</p>';
                availableBooksList.innerHTML = '<p class="text-gray-500 text-center">Please log in to view available books.</p>';
                myIssuedBooksList.innerHTML = '<p class="text-gray-500 text-center">Please log in to view issued books.</p>';
                return;
            }

            const { data: books, error } = await supabase
                .from('books')
                .select('*');

            if (error) {
                console.error("Error fetching books:", error.message);
                showConfirmationModal(`Error loading books: ${error.message}`, () => {});
                return;
            }

            const myBooks = [];
            const availableBooks = [];
            const myIssuedBooks = [];

            books.forEach(book => {
                if (book.owner_id === userId) {
                    myBooks.push(book);
                } else if (book.status === 'available') {
                    availableBooks.push(book);
                } else if (book.status === 'issued' && book.issued_to_person_id === userId) {
                    myIssuedBooks.push(book);
                }
            });
            renderBookLists(myBooks, availableBooks, myIssuedBooks);
        }

        /**
         * Fetches and renders pending requests for the current user.
         */
        async function fetchAndRenderRequests() {
            if (!userId) {
                requestNotification.classList.add('hidden'); // Hide notification if not logged in
                return;
            }

            const { data: requests, error } = await supabase
                .from('requests')
                .select('*')
                .eq('owner_id', userId); // Only fetch requests where current user is the owner

            if (error) {
                console.error("Error fetching requests:", error.message);
                return;
            }
            updateRequestNotification(requests);
            renderPendingRequestsModal(requests);
        }


        /**
         * Renders the different lists of books (My Books, Available, Issued To Me).
         * @param {Array} myBooks
         * @param {Array} availableBooks
         * @param {Array} myIssuedBooks
         */
        function renderBookLists(myBooks, availableBooks, myIssuedBooks) {
            // Render My Books
            myBooksList.innerHTML = '';
            if (myBooks.length === 0) {
                noMyBooksMessage.classList.remove('hidden');
            } else {
                noMyBooksMessage.classList.add('hidden');
                myBooks.forEach(book => {
                    myBooksList.appendChild(createBookCard(book, 'myBook'));
                });
            }

            // Render Available Books for others to request
            availableBooksList.innerHTML = '';
            if (availableBooks.length === 0) {
                noAvailableBooksMessage.classList.remove('hidden');
            } else {
                noAvailableBooksMessage.classList.add('hidden');
                availableBooks.forEach(book => {
                    // Only show 'Request Book' button if the book is not owned by the current user
                    if (book.owner_id !== userId) {
                        availableBooksList.appendChild(createBookCard(book, 'availableForRequest'));
                    }
                });
                // If after filtering, no books are left for request, show message
                if (availableBooksList.children.length === 0 && !noAvailableBooksMessage.classList.contains('hidden')) {
                     noAvailableBooksMessage.classList.remove('hidden');
                } else if (availableBooksList.children.length > 0) {
                    noAvailableBooksMessage.classList.add('hidden');
                }

            }

            // Render Books Issued To Me
            myIssuedBooksList.innerHTML = '';
            if (myIssuedBooks.length === 0) {
                noIssuedBooksMessage.classList.remove('hidden');
            } else {
                noIssuedBooksMessage.classList.add('hidden');
                myIssuedBooks.forEach(book => {
                    myIssuedBooksList.appendChild(createBookCard(book, 'issuedToMe'));
                });
            }
        }

        /**
         * Creates an HTML card for a book.
         * @param {Object} book - The book object.
         * @param {string} type - 'myBook', 'availableForRequest', 'issuedToMe'
         * @returns {HTMLElement} The book card element.
         */
        function createBookCard(book, type) {
            const card = document.createElement('div');
            let statusColor = '';
            let statusText = '';
            let actionsHtml = '';

            switch (book.status) {
                case 'available':
                    statusColor = 'bg-green-100 text-green-800';
                    statusText = 'Available';
                    if (type === 'availableForRequest') { // Only show request if not my own book
                        actionsHtml = `<button class="request-btn mt-2 px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-md hover:bg-blue-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Request Book</button>`;
                    } else if (type === 'myBook') {
                         actionsHtml = `<button class="delete-btn mt-2 px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Delete Book</button>`;
                    }
                    break;
                case 'requested':
                    statusColor = 'bg-yellow-100 text-yellow-800';
                    statusText = `Requested by ${book.requested_by_person_name}`;
                    break;
                case 'issued':
                    statusColor = 'bg-red-100 text-red-800';
                    statusText = `Issued to ${book.issued_to_person_name}`;
                     if (type === 'myBook') { // Owner can mark as returned
                        actionsHtml = `<button class="return-btn mt-2 px-3 py-1 bg-purple-500 text-white text-sm font-semibold rounded-md hover:bg-purple-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Mark as Returned</button>`;
                    } else if (type === 'issuedToMe') { // Person issued to can also mark as returned (optional, but good UX)
                        actionsHtml = `<button class="return-btn mt-2 px-3 py-1 bg-purple-500 text-white text-sm font-semibold rounded-md hover:bg-purple-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Return Book</button>`;
                    }
                    break;
                default:
                    statusColor = 'bg-gray-100 text-gray-800';
                    statusText = 'Unknown Status';
            }

            card.className = `bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4`;
            card.innerHTML = `
                <div class="text-left flex-grow">
                    <p class="text-xl font-bold text-gray-900">${book.book_title}</p>
                    <p class="text-md text-gray-700">by ${book.book_author}</p>
                    <p class="text-sm text-gray-500">Owner: ${book.owner_name}</p>
                    <span class="inline-block mt-2 px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${statusText}</span>
                </div>
                <div class="flex-shrink-0 flex flex-col items-end">
                    ${actionsHtml}
                </div>
            `;

            // Attach event listeners for dynamic buttons
            if (actionsHtml.includes('request-btn')) {
                card.querySelector('.request-btn').addEventListener('click', () => requestBook(book));
            }
            if (actionsHtml.includes('return-btn')) {
                card.querySelector('.return-btn').addEventListener('click', () => returnBook(book));
            }
            if (actionsHtml.includes('delete-btn')) {
                card.querySelector('.delete-btn').addEventListener('click', () => deleteBook(book.id));
            }
            return card;
        }

        /**
         * Updates the request notification badge.
         * @param {Array} pendingRequests - Array of pending request objects.
         */
        function updateRequestNotification(pendingRequests) {
            if (pendingRequests.length > 0) {
                pendingRequestsCount.textContent = pendingRequests.length;
                requestNotification.classList.remove('hidden');
            } else {
                requestNotification.classList.add('hidden');
            }
        }

        /**
         * Renders pending requests in the modal.
         * @param {Array} pendingRequests - Array of pending request objects.
         */
        function renderPendingRequestsModal(pendingRequests) {
            pendingRequestsList.innerHTML = ''; // Clear existing list
            if (pendingRequests.length === 0) {
                noPendingRequestsMessage.classList.remove('hidden');
            } else {
                noPendingRequestsMessage.classList.add('hidden');
                pendingRequests.forEach(request => {
                    const requestCard = document.createElement('div');
                    requestCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-yellow-300 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4';
                    requestCard.innerHTML = `
                        <div class="text-left flex-grow">
                            <p class="text-lg font-medium text-gray-900">Request for: "${request.book_title}"</p>
                            <p class="text-sm text-gray-600">From: ${request.requester_name}</p>
                        </div>
                        <div class="flex-shrink-0 flex flex-col sm:flex-row gap-2">
                            <button class="approve-btn px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-md hover:bg-green-600 transition duration-150 ease-in-out" data-request-id="${request.id}">Approve</button>
                            <button class="reject-btn px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600 transition duration-150 ease-in-out" data-request-id="${request.id}">Reject</button>
                        </div>
                    `;
                    requestCard.querySelector('.approve-btn').addEventListener('click', () => approveRequest(request));
                    requestCard.querySelector('.reject-btn').addEventListener('click', () => rejectRequest(request));
                    pendingRequestsList.appendChild(requestCard);
                });
            }
        }

        viewRequestsBtn.addEventListener('click', () => {
            requestsModal.style.display = 'flex';
        });

        // Initialize Supabase Authentication on window load
        window.onload = initSupabaseAuth;

        // Set initial view (default to registration form)
        toggleToLogin.classList.add('hidden'); // Initially hide "Already have an account?"
        registrationFields.classList.remove('hidden'); // Show registration fields by default
        loginBtn.classList.add('hidden'); // Hide login button
        // registerBtn is visible by default (as it's the primary action on load)
    </script>
</body>
</html>
