<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swayam Library (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            line-height: 1.6;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4 text-center">Swayam Library</h1>
        <p id="currentUserId" class="text-sm text-gray-600 text-center mb-6 break-words">Your User ID: Loading...</p>

        <!-- Notification for requests -->
        <div id="requestNotification" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md shadow-sm" role="alert">
            <p class="font-bold">New Book Request!</p>
            <p>You have <span id="pendingRequestsCount">0</span> pending book requests.</p>
            <button id="viewRequestsBtn" class="mt-2 text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out">
                View Requests
            </button>
        </div>

        <!-- Add Book Section -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200 shadow-sm">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4">Add a New Book</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="bookTitleInput" class="block text-sm font-medium text-gray-700 mb-1">Book Title</label>
                    <input type="text" id="bookTitleInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="The Great Gatsby">
                </div>
                <div>
                    <label for="bookAuthorInput" class="block text-sm font-medium text-gray-700 mb-1">Author</label>
                    <input type="text" id="bookAuthorInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="F. Scott Fitzgerald">
                </div>
                 <div>
                    <label for="ownerNameInput" class="block text-sm font-medium text-gray-700 mb-1">Your Name (as Book Owner)</label>
                    <input type="text" id="ownerNameInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Your Name">
                </div>
            </div>
            <button id="addBookBtn" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                Add Book to Library
            </button>
        </div>

        <!-- My Books Section -->
        <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200 shadow-sm">
            <h2 class="text-2xl font-semibold text-purple-800 mb-4">My Books</h2>
            <div id="myBooksList" class="space-y-4">
                <p id="noMyBooksMessage" class="text-gray-500 text-center">You haven't added any books yet.</p>
            </div>
        </div>

        <!-- All Available Books Section -->
        <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200 shadow-sm">
            <h2 class="text-2xl font-semibold text-green-800 mb-4">All Available Books (for Request)</h2>
            <div id="availableBooksList" class="space-y-4">
                <p id="noAvailableBooksMessage" class="text-gray-500 text-center">No books currently available for request from other users.</p>
            </div>
        </div>

        <!-- My Issued Books Section -->
        <div class="mb-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200 shadow-sm">
            <h2 class="text-2xl font-semibold text-indigo-800 mb-4">Books Issued To Me</h2>
            <div id="myIssuedBooksList" class="space-y-4">
                <p id="noIssuedBooksMessage" class="text-gray-500 text-center">You currently have no books issued to you.</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-medium text-gray-800"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">Confirm</button>
                <button id="modalCancelBtn" class="px-5 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Request Management Modal -->
    <div id="requestsModal" class="modal">
        <div class="modal-content w-full sm:w-1/2 max-w-2xl">
            <span class="close-button" id="closeRequestsModalBtn">&times;</span>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Pending Book Requests</h3>
            <div id="pendingRequestsList" class="space-y-4 max-h-96 overflow-y-auto">
                <p id="noPendingRequestsMessage" class="text-gray-500 text-center">No pending requests at the moment.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration ---
        // !!! IMPORTANT: YOU MUST REPLACE THESE WITH YOUR ACTUAL SUPABASE PROJECT URL AND ANON KEY !!!
        // You can find these in your Supabase Dashboard under Project Settings -> API.
        const SUPABASE_URL = 'https://tmtjqlhinhjpumzgsspa.supabase.co'; // e.g., 'https://abcde12345.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtdGpxbGhpbmhqcHVtemdzc3BhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyOTg0NDUsImV4cCI6MjA2NTg3NDQ0NX0.h75Cd0FbniB7gTE_xj7aHoiJjlkOVIwmgGfaMH4DNRc'; // e.g., 'eyJhbGciOiJIUzI1Ni...'

        // Log the values to console to aid debugging if URL is still invalid
        console.log("Supabase URL being used:", SUPABASE_URL);
        console.log("Supabase Anon Key being used (first few chars):", SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.substring(0, 10) + '...' : 'Not provided');


        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let userId = null;
        let userName = ''; // To store the user's name if they add books

        // UI Elements
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const bookTitleInput = document.getElementById('bookTitleInput');
        const bookAuthorInput = document.getElementById('bookAuthorInput');
        const ownerNameInput = document.getElementById('ownerNameInput');
        const addBookBtn = document.getElementById('addBookBtn');
        const myBooksList = document.getElementById('myBooksList');
        const noMyBooksMessage = document.getElementById('noMyBooksMessage');
        const availableBooksList = document.getElementById('availableBooksList');
        const noAvailableBooksMessage = document.getElementById('noAvailableBooksMessage');
        const myIssuedBooksList = document.getElementById('myIssuedBooksList');
        const noIssuedBooksMessage = document.getElementById('noIssuedBooksMessage');
        const requestNotification = document.getElementById('requestNotification');
        const pendingRequestsCount = document.getElementById('pendingRequestsCount');
        const viewRequestsBtn = document.getElementById('viewRequestsBtn');
        const requestsModal = document.getElementById('requestsModal');
        const closeRequestsModalBtn = document.getElementById('closeRequestsModalBtn');
        const pendingRequestsList = document.getElementById('pendingRequestsList');
        const noPendingRequestsMessage = document.getElementById('noPendingRequestsMessage');

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const closeModalButtons = document.querySelectorAll('.close-button'); // For all modals

        let currentModalAction = null; // Stores the function to execute on modal confirmation

        // --- Supabase Authentication ---
        async function initSupabaseAuth() {
            try {
                // Try to get current session
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    userId = session.user.id;
                    currentUserIdDisplay.textContent = `Your User ID: ${userId}`;
                    console.log('Signed in as:', userId);
                } else {
                    // Sign in anonymously if no session exists
                    const { data, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                        console.error('Error signing in anonymously:', error.message);
                        currentUserIdDisplay.textContent = `Error signing in. Check console.`;
                        showConfirmationModal(`Error signing in: ${error.message}`, () => {});
                        return;
                    }
                    userId = data.user.id;
                    currentUserIdDisplay.textContent = `Your User ID: ${userId}`;
                    console.log('Signed in anonymously as:', userId);
                }
                setupSupabaseListeners(); // Start listening to data once authenticated
            } catch (error) {
                console.error("Error initializing Supabase Auth:", error);
                currentUserIdDisplay.textContent = `Error initializing Auth. Check console.`;
            }
        }

        // --- Confirmation Modal Functions ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmationModal.style.display = 'flex';
            currentModalAction = onConfirm;
        }

        function hideConfirmationModal() {
            confirmationModal.style.display = 'none';
            currentModalAction = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (currentModalAction) {
                currentModalAction();
            }
            hideConfirmationModal();
        });

        modalCancelBtn.addEventListener('click', () => {
            hideConfirmationModal();
        });

        // Close buttons for both modals
        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                requestsModal.style.display = 'none';
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target == confirmationModal) {
                hideConfirmationModal();
            }
            if (event.target == requestsModal) {
                requestsModal.style.display = 'none';
            }
        });


        // --- Supabase Database Operations ---

        /**
         * Adds a new book to Supabase.
         */
        addBookBtn.addEventListener('click', async () => {
            if (!userId) {
                showConfirmationModal("Please wait for authentication to complete.", () => {});
                return;
            }

            const title = bookTitleInput.value.trim();
            const author = bookAuthorInput.value.trim();
            userName = ownerNameInput.value.trim(); // Update userName from input

            if (!title || !author || !userName) {
                showConfirmationModal("Please fill in all book details (Title, Author, Your Name).", () => {});
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('books')
                    .insert([
                        {
                            owner_id: userId,
                            owner_name: userName,
                            book_title: title,
                            book_author: author,
                            status: 'available'
                        }
                    ]);

                if (error) throw error;

                bookTitleInput.value = '';
                bookAuthorInput.value = '';
                // Keep ownerNameInput value as it might be used repeatedly
                showConfirmationModal("Book added successfully!", () => {});
            } catch (e) {
                console.error("Error adding book: ", e);
                showConfirmationModal(`Error adding book: ${e.message}`, () => {});
            }
        });

        /**
         * Sends a request for a book.
         * @param {Object} book - The book object to request.
         */
        async function requestBook(book) {
            if (!userId) {
                showConfirmationModal("Please wait for authentication to complete.", () => {});
                return;
            }
            if (book.status !== 'available') {
                showConfirmationModal("This book is not available for request.", () => {});
                return;
            }
            if (book.owner_id === userId) {
                 showConfirmationModal("You cannot request your own book.", () => {});
                return;
            }

            showConfirmationModal(`Are you sure you want to request "${book.book_title}" from ${book.owner_name}?`, async () => {
                try {
                    // Update book status to 'requested'
                    const { error: bookUpdateError } = await supabase
                        .from('books')
                        .update({
                            status: 'requested',
                            requested_by_person_id: userId,
                            requested_by_person_name: ownerNameInput.value.trim() || 'Anonymous Requester' // Use ownerNameInput for requester name if set
                        })
                        .eq('id', book.id);

                    if (bookUpdateError) throw bookUpdateError;

                    // Create a request document
                    const { data: requestData, error: requestError } = await supabase
                        .from('requests')
                        .insert([
                            {
                                book_id: book.id,
                                book_title: book.book_title,
                                owner_id: book.owner_id,
                                owner_name: book.owner_name,
                                requester_id: userId,
                                requester_name: ownerNameInput.value.trim() || 'Anonymous Requester' // Use ownerNameInput for requester name if set
                            }
                        ]);

                    if (requestError) throw requestError;

                    showConfirmationModal(`Request for "${book.book_title}" sent successfully!`, () => {});
                } catch (e) {
                    console.error("Error requesting book: ", e);
                    showConfirmationModal(`Error requesting book: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Approves a book request.
         * @param {Object} request - The request object.
         */
        async function approveRequest(request) {
            if (!userId || request.owner_id !== userId) return; // Only owner can approve

            showConfirmationModal(`Approve request for "${request.book_title}" by ${request.requester_name}?`, async () => {
                try {
                    // Update book status to 'issued' and assign to requester
                    const { error: bookUpdateError } = await supabase
                        .from('books')
                        .update({
                            status: 'issued',
                            issued_to_person_id: request.requester_id,
                            issued_to_person_name: request.requester_name,
                            requested_by_person_id: null, // Clear request fields
                            requested_by_person_name: null
                        })
                        .eq('id', request.book_id);

                    if (bookUpdateError) throw bookUpdateError;

                    // Delete the request
                    const { error: requestDeleteError } = await supabase
                        .from('requests')
                        .delete()
                        .eq('id', request.id);

                    if (requestDeleteError) throw requestDeleteError;

                    showConfirmationModal(`Request for "${request.book_title}" approved!`, () => {});
                } catch (e) {
                    console.error("Error approving request: ", e);
                    showConfirmationModal(`Error approving request: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Rejects a book request.
         * @param {Object} request - The request object.
         */
        async function rejectRequest(request) {
            if (!userId || request.owner_id !== userId) return; // Only owner can reject

            showConfirmationModal(`Reject request for "${request.book_title}" by ${request.requester_name}?`, async () => {
                try {
                    // Update book status back to 'available'
                    const { error: bookUpdateError } = await supabase
                        .from('books')
                        .update({
                            status: 'available',
                            requested_by_person_id: null, // Clear request fields
                            requested_by_person_name: null
                        })
                        .eq('id', request.book_id);

                    if (bookUpdateError) throw bookUpdateError;

                    // Delete the request
                    const { error: requestDeleteError } = await supabase
                        .from('requests')
                        .delete()
                        .eq('id', request.id);

                    if (requestDeleteError) throw requestDeleteError;

                    showConfirmationModal(`Request for "${request.book_title}" rejected.`, () => {});
                } catch (e) {
                    console.error("Error rejecting request: ", e);
                    showConfirmationModal(`Error rejecting request: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Marks an issued book as returned.
         * @param {Object} book - The book object to return.
         */
        async function returnBook(book) {
            // Only the owner or the person it's issued to can mark as returned
            if (!userId || (book.owner_id !== userId && book.issued_to_person_id !== userId)) {
                showConfirmationModal("You are not authorized to return this book.", () => {});
                return;
            }

            showConfirmationModal(`Confirm returning "${book.book_title}"?`, async () => {
                try {
                    const { error } = await supabase
                        .from('books')
                        .update({
                            status: 'available',
                            issued_to_person_id: null,
                            issued_to_person_name: null
                        })
                        .eq('id', book.id);

                    if (error) throw error;
                    showConfirmationModal(`"${book.book_title}" marked as returned and available.`, () => {});
                } catch (e) {
                    console.error("Error returning book: ", e);
                    showConfirmationModal(`Error returning book: ${e.message}`, () => {});
                }
            });
        }

        /**
         * Deletes a book from Supabase.
         * @param {string} bookId - The ID of the book to delete.
         */
        async function deleteBook(bookId) {
            showConfirmationModal("Are you sure you want to delete this book? This action cannot be undone.", async () => {
                try {
                    const { error } = await supabase
                        .from('books')
                        .delete()
                        .eq('id', bookId);

                    if (error) throw error;
                    showConfirmationModal("Book deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting book: ", e);
                    showConfirmationModal(`Error deleting book: ${e.message}`, () => {});
                }
            });
        }


        // --- Real-time Listeners and UI Rendering ---
        function setupSupabaseListeners() {
            // Listener for all books (real-time changes)
            supabase
                .from('books')
                .on('*', payload => { // Listen to all changes (INSERT, UPDATE, DELETE)
                    console.log('Book change received!', payload);
                    fetchAndRenderBooks(); // Re-fetch and re-render all lists
                })
                .subscribe();

            // Listener for incoming requests (only for the current user as owner)
            supabase
                .from('requests')
                .on('*', payload => { // Listen to all changes (INSERT, UPDATE, DELETE)
                    console.log('Request change received!', payload);
                    fetchAndRenderRequests(); // Re-fetch and re-render requests
                })
                .subscribe();

            // Initial fetch and render
            fetchAndRenderBooks();
            fetchAndRenderRequests();
        }

        /**
         * Fetches and renders all book lists from Supabase.
         */
        async function fetchAndRenderBooks() {
            if (!userId) return; // Ensure user ID is available

            const { data: books, error } = await supabase
                .from('books')
                .select('*');

            if (error) {
                console.error("Error fetching books:", error.message);
                showConfirmationModal(`Error loading books: ${error.message}`, () => {});
                return;
            }

            const myBooks = [];
            const availableBooks = [];
            const myIssuedBooks = [];

            books.forEach(book => {
                if (book.owner_id === userId) {
                    myBooks.push(book);
                } else if (book.status === 'available') {
                    availableBooks.push(book);
                } else if (book.status === 'issued' && book.issued_to_person_id === userId) {
                    myIssuedBooks.push(book);
                }
            });
            renderBookLists(myBooks, availableBooks, myIssuedBooks);
        }

        /**
         * Fetches and renders pending requests for the current user.
         */
        async function fetchAndRenderRequests() {
            if (!userId) return; // Ensure user ID is available

            const { data: requests, error } = await supabase
                .from('requests')
                .select('*')
                .eq('owner_id', userId); // Only fetch requests where current user is the owner

            if (error) {
                console.error("Error fetching requests:", error.message);
                return;
            }
            updateRequestNotification(requests);
            renderPendingRequestsModal(requests);
        }


        /**
         * Renders the different lists of books (My Books, Available, Issued To Me).
         * @param {Array} myBooks
         * @param {Array} availableBooks
         * @param {Array} myIssuedBooks
         */
        function renderBookLists(myBooks, availableBooks, myIssuedBooks) {
            // Render My Books
            myBooksList.innerHTML = '';
            if (myBooks.length === 0) {
                noMyBooksMessage.classList.remove('hidden');
            } else {
                noMyBooksMessage.classList.add('hidden');
                myBooks.forEach(book => {
                    myBooksList.appendChild(createBookCard(book, 'myBook'));
                });
            }

            // Render Available Books for others to request
            availableBooksList.innerHTML = '';
            if (availableBooks.length === 0) {
                noAvailableBooksMessage.classList.remove('hidden');
            } else {
                noAvailableBooksMessage.classList.add('hidden');
                availableBooks.forEach(book => {
                    availableBooksList.appendChild(createBookCard(book, 'availableForRequest'));
                });
            }

            // Render Books Issued To Me
            myIssuedBooksList.innerHTML = '';
            if (myIssuedBooks.length === 0) {
                noIssuedBooksMessage.classList.remove('hidden');
            } else {
                noIssuedBooksMessage.classList.add('hidden');
                myIssuedBooks.forEach(book => {
                    myIssuedBooksList.appendChild(createBookCard(book, 'issuedToMe'));
                });
            }
        }

        /**
         * Creates an HTML card for a book.
         * @param {Object} book - The book object.
         * @param {string} type - 'myBook', 'availableForRequest', 'issuedToMe'
         * @returns {HTMLElement} The book card element.
         */
        function createBookCard(book, type) {
            const card = document.createElement('div');
            let statusColor = '';
            let statusText = '';
            let actionsHtml = '';

            switch (book.status) {
                case 'available':
                    statusColor = 'bg-green-100 text-green-800';
                    statusText = 'Available';
                    if (type === 'availableForRequest') { // Only show request if not my own book
                        actionsHtml = `<button class="request-btn mt-2 px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-md hover:bg-blue-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Request Book</button>`;
                    } else if (type === 'myBook') {
                         actionsHtml = `<button class="delete-btn mt-2 px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Delete Book</button>`;
                    }
                    break;
                case 'requested':
                    statusColor = 'bg-yellow-100 text-yellow-800';
                    statusText = `Requested by ${book.requested_by_person_name}`;
                    break;
                case 'issued':
                    statusColor = 'bg-red-100 text-red-800';
                    statusText = `Issued to ${book.issued_to_person_name}`;
                     if (type === 'myBook') { // Owner can mark as returned
                        actionsHtml = `<button class="return-btn mt-2 px-3 py-1 bg-purple-500 text-white text-sm font-semibold rounded-md hover:bg-purple-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Mark as Returned</button>`;
                    } else if (type === 'issuedToMe') { // Person issued to can also mark as returned (optional, but good UX)
                        actionsHtml = `<button class="return-btn mt-2 px-3 py-1 bg-purple-500 text-white text-sm font-semibold rounded-md hover:bg-purple-600 transition duration-150 ease-in-out" data-book-id="${book.id}">Return Book</button>`;
                    }
                    break;
                default:
                    statusColor = 'bg-gray-100 text-gray-800';
                    statusText = 'Unknown Status';
            }

            card.className = `bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4`;
            card.innerHTML = `
                <div class="text-left flex-grow">
                    <p class="text-xl font-bold text-gray-900">${book.book_title}</p>
                    <p class="text-md text-gray-700">by ${book.book_author}</p>
                    <p class="text-sm text-gray-500">Owner: ${book.owner_name}</p>
                    <span class="inline-block mt-2 px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${statusText}</span>
                </div>
                <div class="flex-shrink-0 flex flex-col items-end">
                    ${actionsHtml}
                </div>
            `;

            // Attach event listeners for dynamic buttons
            if (actionsHtml.includes('request-btn')) {
                card.querySelector('.request-btn').addEventListener('click', () => requestBook(book));
            }
            if (actionsHtml.includes('return-btn')) {
                card.querySelector('.return-btn').addEventListener('click', () => returnBook(book));
            }
            if (actionsHtml.includes('delete-btn')) {
                card.querySelector('.delete-btn').addEventListener('click', () => deleteBook(book.id));
            }
            return card;
        }

        /**
         * Updates the request notification badge.
         * @param {Array} pendingRequests - Array of pending request objects.
         */
        function updateRequestNotification(pendingRequests) {
            if (pendingRequests.length > 0) {
                pendingRequestsCount.textContent = pendingRequests.length;
                requestNotification.classList.remove('hidden');
            } else {
                requestNotification.classList.add('hidden');
            }
        }

        /**
         * Renders pending requests in the modal.
         * @param {Array} pendingRequests - Array of pending request objects.
         */
        function renderPendingRequestsModal(pendingRequests) {
            pendingRequestsList.innerHTML = ''; // Clear existing list
            if (pendingRequests.length === 0) {
                noPendingRequestsMessage.classList.remove('hidden');
            } else {
                noPendingRequestsMessage.classList.add('hidden');
                pendingRequests.forEach(request => {
                    const requestCard = document.createElement('div');
                    requestCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-yellow-300 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4';
                    requestCard.innerHTML = `
                        <div class="text-left flex-grow">
                            <p class="text-lg font-medium text-gray-900">Request for: "${request.book_title}"</p>
                            <p class="text-sm text-gray-600">From: ${request.requester_name}</p>
                        </div>
                        <div class="flex-shrink-0 flex flex-col sm:flex-row gap-2">
                            <button class="approve-btn px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-md hover:bg-green-600 transition duration-150 ease-in-out" data-request-id="${request.id}">Approve</button>
                            <button class="reject-btn px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600 transition duration-150 ease-in-out" data-request-id="${request.id}">Reject</button>
                        </div>
                    `;
                    requestCard.querySelector('.approve-btn').addEventListener('click', () => approveRequest(request));
                    requestCard.querySelector('.reject-btn').addEventListener('click', () => rejectRequest(request));
                    pendingRequestsList.appendChild(requestCard);
                });
            }
        }

        viewRequestsBtn.addEventListener('click', () => {
            requestsModal.style.display = 'flex';
        });

        // Initialize Supabase Authentication on window load
        window.onload = initSupabaseAuth;
    </script>
</body>
</html>
